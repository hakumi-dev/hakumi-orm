module HakumiORM
  class SqlCompiler
    JOIN_KEYWORDS: Hash[Symbol, String]

    def initialize: (Dialect::Base dialect) -> void

    def select: (
      table: String,
      columns: Array[FieldRef],
      ?where_expr: Expr?,
      ?orders: Array[OrderClause],
      ?joins: Array[JoinClause],
      ?limit_val: Integer?,
      ?offset_val: Integer?
    ) -> CompiledQuery

    def count: (table: String, ?where_expr: Expr?) -> CompiledQuery
    def delete: (table: String, ?where_expr: Expr?) -> CompiledQuery

    def update: (
      table: String,
      assignments: Array[Assignment],
      ?where_expr: Expr?
    ) -> CompiledQuery

    def insert: (
      table: String,
      columns: Array[FieldRef],
      values: Array[Array[Bind]],
      ?returning: FieldRef?
    ) -> CompiledQuery

    private

    def compile_expr: (Expr expr, String buf, Array[Bind] binds, Integer idx) -> Integer
    def compile_predicate: (Predicate pred, String buf, Array[Bind] binds, Integer idx) -> Integer
    def join_keyword: (Symbol join_type) -> String
  end
end
