#!/usr/bin/env bash
set -euo pipefail

echo "==> Installing dependencies"
bundle install --quiet

echo ""
echo "==> Markdown lint"
bundle exec mdl README.md lib/hakumi_orm/README.md CHANGELOG.md CODE_OF_CONDUCT.md

echo ""
echo "==> RuboCop"
bundle exec rubocop

echo ""
echo "==> Security audit"
bundle exec ruby bin/security_audit

echo ""
echo "==> Semgrep"
bin/semgrep_ci

echo ""
echo "==> Sorbet"
bundle exec srb tc

echo ""
echo "==> Tests"
TEST_FILES="$(
  find test -type f -name 'test_*.rb' \
    | sort \
    | grep -v '/test_real_db_roundtrip.rb$' \
    | grep -v '/test_real_db_concurrency.rb$'
)"
bundle exec ruby -Itest -e 'ARGV.each { |f| require File.expand_path(f) }' ${TEST_FILES}

echo ""
echo "==> All checks passed"
