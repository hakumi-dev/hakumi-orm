#!/usr/bin/env bash
set -euo pipefail

echo "==> Installing dependencies"
bundle install --quiet

echo ""
echo "==> Markdown lint"
bundle exec mdl README.md lib/hakumi_orm/README.md CHANGELOG.md CODE_OF_CONDUCT.md

echo ""
echo "==> RuboCop"
bundle exec rubocop

echo ""
echo "==> Security audit"
bundle exec ruby bin/security_audit

echo ""
echo "==> Semgrep"
if command -v semgrep >/dev/null 2>&1 || [ -x ".venv-semgrep/bin/semgrep" ]; then
  bin/semgrep_ci
else
  echo "Semgrep skipped: semgrep is not installed in this environment."
fi

echo ""
echo "==> Sorbet"
bundle exec srb tc

echo ""
echo "==> Architecture boundaries (current)"
bundle exec ruby bin/architecture_check --profile current

echo ""
echo "==> Architecture boundaries (target)"
bundle exec ruby bin/architecture_check --profile target --write-mermaid docs/architecture_layers_target.mmd

echo ""
echo "==> Tests"
TEST_FILES="$(
  find test -type f -name 'test_*.rb' \
    | sort \
    | grep -v '/test_real_db_roundtrip.rb$' \
    | grep -v '/test_real_db_concurrency.rb$'
)"
bundle exec ruby -Itest -e 'ARGV.each { |f| require File.expand_path(f) }' ${TEST_FILES}

echo ""
echo "==> All checks passed"
