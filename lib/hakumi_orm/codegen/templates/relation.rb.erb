# typed: strict
# frozen_string_literal: true
# GENERATED BY hakumi-orm -- DO NOT EDIT

<%- if module_name -%>
module <%= module_name %>
<%- end -%>
<%= ind %>class <%= relation_class_name %> < ::HakumiORM::Relation
<%= ind %>  extend T::Sig

<%= ind %>  ModelType = type_member {{ fixed: <%= qualified_record_class %> }}

<%= ind %>  sig { override.returns(T.nilable(String)) }
<%= ind %>  def stmt_count_all = '<%= stmt_count_name %>'

<%= ind %>  sig { override.returns(T.nilable(String)) }
<%= ind %>  def sql_count_all = '<%= count_sql %>'

<%= ind %>  sig { void }
<%= ind %>  def initialize
<%= ind %>    super(<%= qualified_schema %>::TABLE_NAME, <%= qualified_schema %>::ALL)
<%= ind %>  end

<%= ind %>  sig { override.params(result: ::HakumiORM::Adapter::Result).returns(T::Array[<%= qualified_record_class %>]) }
<%= ind %>  def hydrate(result)
<%= ind %>    <%= qualified_record_class %>.from_result(result)
<%= ind %>  end
<%- if preloadable_assocs.any? -%>

<%= ind %>  sig { override.params(records: T::Array[<%= qualified_record_class %>], nodes: T::Array[::HakumiORM::PreloadNode], adapter: ::HakumiORM::Adapter::Base).void }
<%= ind %>  def run_preloads(records, nodes, adapter)
<%= ind %>    nodes.each do |node|
<%= ind %>      case node.name
<%- preloadable_assocs.each do |assoc| -%>
<%= ind %>      when :<%= assoc[:method_name] %>
<%= ind %>        <%= qualified_record_class %>.preload_<%= assoc[:method_name] %>(records, adapter: adapter)
<%- if assoc[:relation_class] -%>
<%= ind %>        unless node.children.empty?
<%= ind %>          all_children = records.flat_map { |r| r._preloaded_<%= assoc[:method_name] %> || [] }
<%= ind %>          <%= assoc[:relation_class] %>.new.run_preloads(all_children, node.children, adapter) unless all_children.empty?
<%= ind %>        end
<%- end -%>
<%- end -%>
<%= ind %>      end
<%= ind %>    end
<%= ind %>  end
<%- end -%>
<%= ind %>end
<%- if module_name -%>
end
<%- end -%>
